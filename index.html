import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    onAuthStateChanged,
    signInWithCustomToken
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    onSnapshot, 
    doc, 
    updateDoc,
    Timestamp,
    query,
    deleteDoc
} from 'firebase/firestore';

// --- SVG Icons ---
const TruckIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-5 w-5"><path d="M10 17h4V5H2v12h3m-3 0l-1.5-3.5h13L18 17m-8 0h4m-4 0l-1.5 3.5h13L18 17m-8 0h4M14 5h7l3 5v7h-4v-4h-2v4H14V5z"></path><circle cx="7.5" cy="17.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>;
const PackageIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-6 w-6 text-gray-500"><path d="M16.5 9.4a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"></path><path d="M19 13.3a9 9 0 1 1-14 0"></path><path d="M12 17.5V22"></path><path d="m9 17.5 3-3 3 3"></path></svg>;
const MailIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const BoxIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
const CloseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-6 w-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
const ArchiveIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>;
const RestoreIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><rect x="1" y="3" width="22" height="5"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>;
const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
const DashboardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>;
const ReportIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
const ExcelIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><path d="m16 13-3.5 3.5" /><path d="m12.5 13-3.5 3.5" /><path d="m16 16.5-3.5-3.5" /><path d="m12.5 16.5-3.5-3.5" /></svg>;

// --- Main App Component ---
export default function App() {
    // --- State Variables ---
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    const [cargas, setCargas] = useState([]);
    const [clientes, setClientes] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    // View state
    const [view, setView] = useState('dashboard'); // dashboard, cargas, clientes, reportes
    const [cargasFilter, setCargasFilter] = useState('activos'); // 'activos' or 'archivados'

    // Form state
    const [selectedClientId, setSelectedClientId] = useState('');
    const [cliente, setCliente] = useState('');
    const [email, setEmail] = useState('');
    const [cotizacion, setCotizacion] = useState('');
    const [origen, setOrigen] = useState('');
    const [destino, setDestino] = useState('');
    const [estatus, setEstatus] = useState('Recibido');
    const [entregaEstimada, setEntregaEstimada] = useState('');
    const [peso, setPeso] = useState('');
    const [piezas, setPiezas] = useState('');
    const [referenciaEnvio, setReferenciaEnvio] = useState('');
    const [costoEnvio, setCostoEnvio] = useState('');
    const [precioVenta, setPrecioVenta] = useState('');
    
    // Client management state
    const [newClientName, setNewClientName] = useState('');
    const [newClientEmail, setNewClientEmail] = useState('');
    
    // Modal state
    const [isEditModalOpen, setIsEditModalOpen] = useState(false);
    const [editingCarga, setEditingCarga] = useState(null);
    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
    const [itemToDelete, setItemToDelete] = useState(null);

    const [error, setError] = useState('');
    const [clientError, setClientError] = useState('');

    const statusOptions = ["Recibido", "En Coordinación", "En Bodega", "En Tránsito", "Entregado", "Retrasado", "Cancelado"];
    const statusColors = { 
        "Recibido": "bg-blue-100 text-blue-800", 
        "En Coordinación": "bg-orange-100 text-orange-800",
        "En Bodega": "bg-purple-100 text-purple-800", 
        "En Tránsito": "bg-yellow-100 text-yellow-800", 
        "Entregado": "bg-green-100 text-green-800", 
        "Retrasado": "bg-red-100 text-red-800", 
        "Cancelado": "bg-gray-200 text-gray-800" 
    };

    // --- Firebase & External Scripts Initialization ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    useEffect(() => {
        // Load XLSX script for Excel export
        const script = document.createElement('script');
        script.src = "https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js";
        script.async = true;
        document.head.appendChild(script);

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(firestoreDb);
            setAuth(authInstance);

            onAuthStateChanged(authInstance, async (user) => {
                if (user) setUserId(user.uid);
                else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                        else await signInAnonymously(authInstance);
                    } catch (authError) { console.error("Error during sign-in:", authError); }
                }
                setIsAuthReady(true);
            });
        } catch (e) { console.error("Error initializing Firebase:", e); setError("Error de configuración de Firebase."); }

        return () => {
            document.head.removeChild(script);
        };
    }, [appId]);

    // --- Data Fetching from Firestore ---
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;
        setIsLoading(true);
        const unsubCargas = onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/cargas`)), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => (b.fechaCreacion?.toDate() || 0) - (a.fechaCreacion?.toDate() || 0));
            setCargas(data);
            setIsLoading(false);
        });
        const unsubClientes = onSnapshot(query(collection(db, `artifacts/${appId}/users/${userId}/clientes`)), (snapshot) => {
            setClientes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => { unsubCargas(); unsubClientes(); };
    }, [isAuthReady, db, userId, appId]);

    // --- Handlers ---
    const handleSelectClient = (clientId) => {
        setSelectedClientId(clientId);
        const selected = clientes.find(c => c.id === clientId);
        setCliente(selected ? selected.nombre : '');
        setEmail(selected ? selected.email : '');
    };

    const handleAgregarCarga = async (e) => {
        e.preventDefault();
        if (!cliente || !email || !origen || !destino) { setError('Por favor, complete todos los campos obligatorios.'); return; }
        setError('');
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/cargas`), {
                cliente, email, cotizacion, origen, destino, estatus,
                entregaEstimada, peso, piezas, referenciaEnvio,
                costoEnvio: parseFloat(costoEnvio) || 0,
                precioVenta: parseFloat(precioVenta) || 0,
                archivado: false, fechaCreacion: Timestamp.now()
            });
            // Reset form
            setCliente(''); setEmail(''); setCotizacion(''); setOrigen(''); setDestino(''); setEstatus('Recibido'); setEntregaEstimada(''); setPeso(''); setPiezas(''); setReferenciaEnvio(''); setSelectedClientId(''); setCostoEnvio(''); setPrecioVenta('');
        } catch (err) { setError('Ocurrió un error al agregar la carga.'); }
    };
    
    const handleAgregarCliente = async (e) => {
        e.preventDefault();
        if (!newClientName || !newClientEmail) { setClientError('Nombre y Email son requeridos.'); return; }
        setClientError('');
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/clientes`), { nombre: newClientName, email: newClientEmail });
            setNewClientName(''); setNewClientEmail('');
        } catch (err) { setClientError('Ocurrió un error al guardar el cliente.'); }
    };
    
    const handleArchiveToggle = async (id, status) => await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/cargas`, id), { archivado: !status });
    const handleActualizarEstatus = async (id, nuevoEstatus) => await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/cargas`, id), { estatus: nuevoEstatus });
    const handleOpenEditModal = (carga) => { setEditingCarga(carga); setIsEditModalOpen(true); };
    const handleUpdateCarga = async (updatedData) => {
        if (!editingCarga) return;
        const dataToUpdate = { ...updatedData };
        dataToUpdate.costoEnvio = parseFloat(dataToUpdate.costoEnvio) || 0;
        dataToUpdate.precioVenta = parseFloat(dataToUpdate.precioVenta) || 0;
        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/cargas`, editingCarga.id), dataToUpdate);
        setIsEditModalOpen(false); setEditingCarga(null);
    };
    const handleOpenDeleteModal = (id, type) => { setItemToDelete({ id, type }); setIsDeleteModalOpen(true); };
    const handleConfirmDelete = async () => {
        if (!itemToDelete) return;
        const { id, type } = itemToDelete;
        const collectionName = type === 'carga' ? 'cargas' : 'clientes';
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id));
        setIsDeleteModalOpen(false); setItemToDelete(null);
    };

    const generateEmailBody = (carga) => {
        const signature = `\n\n--\nSaludos cordiales,\n\nLowesky Ortiz.\nAsociado de Trafico\nTel. (809) 561-5999\nwww.harryheinsen.com\nCertificado OEA No. DO-OEA-0118`;
        const formatDate = (dateString) => dateString ? new Date(dateString.replace(/-/g, '\/')).toLocaleDateString('es-ES') : 'No especificada';
        const details = `\nDetalles del Embarque:\n- Cliente: ${carga.cliente}\n- Cotización: ${carga.cotizacion || 'N/A'}\n- Referencia: ${carga.referenciaEnvio || 'N/A'}\n- Origen: ${carga.origen}\n- Destino: ${carga.destino}\n- Peso: ${carga.peso || 'N/A'}\n- Piezas: ${carga.piezas || 'N/A'}\n- Entrega Estimada: ${formatDate(carga.entregaEstimada)}`;
        let body;
        switch (carga.estatus) {
            case 'Recibido': body = `Hola ${carga.cliente},\n\nLe confirmamos que hemos recibido su carga y está siendo procesada en nuestras instalaciones.${details}`; break;
            case 'En Coordinación': body = `Hola ${carga.cliente},\n\nLe informamos que su envío se encuentra en proceso de coordinación logística. Pronto le daremos más detalles sobre el tránsito.${details}`; break;
            case 'En Bodega': body = `Hola ${carga.cliente},\n\nSu carga se encuentra segura en nuestra bodega, lista para el próximo paso de su viaje.${details}\n\nLe notificaremos cuando inicie el tránsito.`; break;
            case 'En Tránsito': body = `Hola ${carga.cliente},\n\n¡Buenas noticias! Su envío ya está en tránsito hacia su destino final.${details}`; break;
            case 'Entregado': body = `Hola ${carga.cliente},\n\nNos complace informarle que su envío ha sido entregado con éxito.${details}`; break;
            default: body = `Hola ${carga.cliente},\n\nHay una nueva actualización sobre su envío. Estado actual: ${carga.estatus}.${details}`;
        }
        return body + signature;
    };
    
    const filteredCargas = cargas.filter(c => cargasFilter === 'activos' ? !c.archivado : c.archivado);
    
    const NavButton = ({ targetView, icon, children }) => (
        <button onClick={() => setView(targetView)} className={`w-1/4 flex items-center justify-center p-2 rounded-md transition ${view === targetView ? 'bg-white shadow' : 'hover:bg-gray-100'}`}>
            {icon} {children}
        </button>
    );

    return (
        <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
            <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <header className="mb-6 no-print">
                    <div className="flex items-center justify-center mb-4"><TruckIcon /><h1 className="text-3xl sm:text-4xl font-bold tracking-tight text-gray-900">Panel de Control de Envíos</h1></div>
                    <div className="flex justify-center bg-gray-200 p-1 rounded-lg">
                        <NavButton targetView="dashboard" icon={<DashboardIcon />}>Dashboard</NavButton>
                        <NavButton targetView="cargas" icon={<BoxIcon />}>Cargas</NavButton>
                        <NavButton targetView="clientes" icon={<UsersIcon />}>Clientes</NavButton>
                        <NavButton targetView="reportes" icon={<ReportIcon />}>Reportes</NavButton>
                    </div>
                </header>

                <div className={view === 'dashboard' ? '' : 'no-print'}>
                    {view === 'dashboard' && <DashboardView cargas={cargas} />}
                </div>
                
                <div className={view === 'cargas' ? '' : 'no-print'}>
                    {view === 'cargas' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-1">
                                <div className="bg-white p-6 rounded-xl shadow-md sticky top-8">
                                    <h2 className="text-xl font-semibold mb-4 border-b pb-2">Agregar Nueva Carga</h2>
                                    <form onSubmit={handleAgregarCarga} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">Cliente</label>
                                            <select onChange={(e) => handleSelectClient(e.target.value)} value={selectedClientId} className="mt-1 block w-full input-style">
                                                <option value="">Seleccione un cliente</option>
                                                {clientes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}
                                                <option value="new">-- Nuevo Cliente --</option>
                                            </select>
                                        </div>
                                        {selectedClientId === 'new' && (<>
                                            <div><label className="block text-sm font-medium">Nombre Cliente</label><input type="text" value={cliente} onChange={(e) => setCliente(e.target.value)} className="mt-1 block w-full input-style" required/></div>
                                            <div><label className="block text-sm font-medium">Email Cliente</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="mt-1 block w-full input-style" required/></div>
                                        </>)}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-sm font-medium">Costo Envío</label><input type="number" value={costoEnvio} onChange={(e) => setCostoEnvio(e.target.value)} className="mt-1 block w-full input-style" placeholder="100.00"/></div>
                                            <div><label className="block text-sm font-medium">Precio Venta</label><input type="number" value={precioVenta} onChange={(e) => setPrecioVenta(e.target.value)} className="mt-1 block w-full input-style" placeholder="150.00"/></div>
                                            <div><label className="block text-sm font-medium">Nº Cotización</label><input type="text" value={cotizacion} onChange={(e) => setCotizacion(e.target.value)} className="mt-1 block w-full input-style"/></div>
                                            <div><label className="block text-sm font-medium">Nº Referencia</label><input type="text" value={referenciaEnvio} onChange={(e) => setReferenciaEnvio(e.target.value)} className="mt-1 block w-full input-style"/></div>
                                            <div className="col-span-2"><label className="block text-sm font-medium">Origen</label><input type="text" value={origen} onChange={(e) => setOrigen(e.target.value)} className="mt-1 block w-full input-style" required/></div>
                                            <div className="col-span-2"><label className="block text-sm font-medium">Destino</label><input type="text" value={destino} onChange={(e) => setDestino(e.target.value)} className="mt-1 block w-full input-style" required/></div>
                                            <div><label className="block text-sm font-medium">Piezas</label><input type="number" value={piezas} onChange={(e) => setPiezas(e.target.value)} className="mt-1 block w-full input-style"/></div>
                                            <div><label className="block text-sm font-medium">Peso</label><input type="text" value={peso} onChange={(e) => setPeso(e.target.value)} className="mt-1 block w-full input-style"/></div>
                                            <div className="col-span-2"><label className="block text-sm font-medium">Entrega Estimada</label><input type="date" value={entregaEstimada} onChange={(e) => setEntregaEstimada(e.target.value)} className="mt-1 block w-full input-style"/></div>
                                            <div className="col-span-2"><label htmlFor="estatus" className="block text-sm font-medium text-gray-700">Estatus Inicial</label>
                                                <select id="estatus" value={estatus} onChange={(e) => setEstatus(e.target.value)} className="mt-1 block w-full input-style">
                                                    {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                                        <button type="submit" className="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Agregar Carga</button>
                                    </form>
                                </div>
                            </div>
                            <div className="lg:col-span-2">
                                <div className="flex justify-center bg-gray-200 p-1 rounded-lg mb-4">
                                    <button onClick={() => setCargasFilter('activos')} className={`w-1/2 p-2 rounded-md transition ${cargasFilter === 'activos' ? 'bg-white shadow' : ''}`}>Activos</button>
                                    <button onClick={() => setCargasFilter('archivados')} className={`w-1/2 p-2 rounded-md transition ${cargasFilter === 'archivados' ? 'bg-white shadow' : ''}`}>Archivados</button>
                                </div>
                                {isLoading ? <div className="text-center py-10"><p>Cargando datos...</p></div> : filteredCargas.length === 0 ? (
                                    <div className="text-center py-16 px-6 bg-white rounded-xl shadow-md"><PackageIcon /><h3 className="mt-2 text-lg font-medium text-gray-900">No hay cargas {cargasFilter === 'activos' ? 'activas' : 'archivadas'}</h3></div>
                                ) : (
                                    <div className="space-y-4">
                                        {filteredCargas.map(carga => <CargaCard key={carga.id} carga={carga} statusOptions={statusOptions} statusColors={statusColors} onStatusChange={handleActualizarEstatus} onEdit={handleOpenEditModal} onArchive={handleArchiveToggle} onDelete={handleOpenDeleteModal} generateEmailBody={generateEmailBody} />)}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
                
                <div className={view === 'clientes' ? '' : 'no-print'}>
                    {view === 'clientes' && <ClientesModule clientes={clientes} onAddClient={handleAgregarCliente} onDeleteClient={handleOpenDeleteModal} clientError={clientError} setClientError={setClientError} newClientName={newClientName} setNewClientName={setNewClientName} newClientEmail={newClientEmail} setNewClientEmail={setNewClientEmail} />}
                </div>

                <div id="report-container">
                    {view === 'reportes' && <ReportesView cargas={cargas} />}
                </div>

                <div className="no-print">
                    {isEditModalOpen && editingCarga && <EditCargaModal carga={editingCarga} onClose={() => setIsEditModalOpen(false)} onSave={handleUpdateCarga} />}
                    {isDeleteModalOpen && <DeleteConfirmModal itemType={itemToDelete?.type} onCancel={() => setIsDeleteModalOpen(false)} onConfirm={handleConfirmDelete} />}
                </div>
            </main>
            <style>{`
                .input-style { box-shadow: sm; border-radius: 0.375rem; border: 1px solid #D1D5DB; background-color: #FFFFFF; padding: 0.5rem 0.75rem; font-size: 0.875rem; width: 100%; } 
                .input-style:focus { outline: none; --tw-ring-color: #6366F1; box-shadow: 0 0 0 1px var(--tw-ring-color); border-color: #6366F1; } 
                .btn-primary, .btn-secondary { display:flex; align-items:center; justify-content:center; padding: 0.5rem 1rem; border-radius: 0.375rem; box-shadow: sm; font-size: 0.875rem; font-weight: 500; color: white; transition: background-color 0.2s; } 
                .btn-secondary { background-color: #4B5563; } .btn-secondary:hover { background-color: #374151; } 
                .btn-primary { background-color: #4f46e5; } .btn-primary:hover { background-color: #4338ca; } 
                .btn-icon { display:flex; align-items:center; font-size: 0.875rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; transition: color 0.2s, background-color 0.2s; }
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    #report-container, #report-container * {
                        visibility: visible;
                    }
                    #report-container {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                    }
                    .no-print-in-report {
                        display: none;
                    }
                }
            `}</style>
        </div>
    );
}

// --- Carga Card Component ---
const CargaCard = ({ carga, statusOptions, statusColors, onStatusChange, onEdit, onArchive, onDelete, generateEmailBody }) => {
    const mailtoLink = `mailto:${carga.email}?subject=${encodeURIComponent(`Actualización de su envío - Cotización: ${carga.cotizacion || 'N/A'}`)}&body=${encodeURIComponent(generateEmailBody(carga))}`;
    const ganancia = (carga.precioVenta || 0) - (carga.costoEnvio || 0);

    return (
        <div className="bg-white p-5 rounded-xl shadow-md">
            <div className="flex justify-between items-start mb-4">
                <div className='flex-grow'><p className="font-bold text-lg">{carga.cliente}</p><p className="text-sm text-gray-500">{carga.email}</p></div>
                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${statusColors[carga.estatus] || 'bg-gray-100'}`}>{carga.estatus}</span>
            </div>
            <div className="border-y py-4 my-4 grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 text-sm">
                <div><p className="font-semibold">Cotización:</p><p>{carga.cotizacion || 'N/A'}</p></div>
                <div><p className="font-semibold">Referencia:</p><p>{carga.referenciaEnvio || 'N/A'}</p></div>
                <div><p className="font-semibold">Ganancia:</p><p className={ganancia >= 0 ? 'text-green-600' : 'text-red-600'}>${ganancia.toFixed(2)}</p></div>
            </div>
            <div className="flex flex-col sm:flex-row gap-2">
                <select value={carga.estatus} onChange={(e) => onStatusChange(carga.id, e.target.value)} className="w-full sm:w-auto flex-grow pl-3 pr-10 py-2 input-style">
                    {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                </select>
                <button onClick={() => onEdit(carga)} className="btn-secondary flex items-center justify-center p-2 rounded-md shadow-sm text-sm font-medium text-white transition hover:bg-gray-700"><EditIcon/> Editar</button>
                <a href={mailtoLink} target="_blank" rel="noopener noreferrer" className="btn-primary flex items-center justify-center p-2 rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700"><MailIcon /> Notificar</a>
            </div>
            <div className="border-t mt-4 pt-2 flex justify-end gap-2">
                <button onClick={() => onArchive(carga.id, carga.archivado)} className="btn-icon text-gray-500 hover:text-blue-600">{carga.archivado ? <><RestoreIcon/> Restaurar</> : <><ArchiveIcon/> Archivar</>}</button>
                <button onClick={() => onDelete(carga.id, 'carga')} className="btn-icon text-gray-500 hover:text-red-600"><TrashIcon/> Eliminar</button>
            </div>
        </div>
    );
};

// --- Dashboard Component ---
const DashboardView = ({ cargas }) => {
    const stats = useMemo(() => {
        const activas = cargas.filter(c => !c.archivado);
        const totalVentas = activas.reduce((sum, c) => sum + (c.precioVenta || 0), 0);
        const totalCostos = activas.reduce((sum, c) => sum + (c.costoEnvio || 0), 0);
        const totalGanancia = totalVentas - totalCostos;
        const enTransito = activas.filter(c => c.estatus === 'En Tránsito').length;
        const entregados = activas.filter(c => c.estatus === 'Entregado').length;
        
        const statusCounts = activas.reduce((acc, c) => {
            acc[c.estatus] = (acc[c.estatus] || 0) + 1;
            return acc;
        }, {});

        return { totalVentas, totalCostos, totalGanancia, enTransito, entregados, totalCargas: activas.length, statusCounts };
    }, [cargas]);

    const StatCard = ({ title, value, colorClass }) => (
        <div className="bg-white p-6 rounded-xl shadow-md">
            <p className="text-sm font-medium text-gray-500">{title}</p>
            <p className={`text-3xl font-bold mt-1 ${colorClass}`}>{value}</p>
        </div>
    );

    return (
        <div className="space-y-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <StatCard title="Ganancia Total" value={`$${stats.totalGanancia.toFixed(2)}`} colorClass="text-green-600" />
                <StatCard title="Ingresos Totales" value={`$${stats.totalVentas.toFixed(2)}`} colorClass="text-blue-600" />
                <StatCard title="Costos Totales" value={`$${stats.totalCostos.toFixed(2)}`} colorClass="text-red-600" />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <StatCard title="Envíos Totales (Activos)" value={stats.totalCargas} />
                <StatCard title="Envíos en Tránsito" value={stats.enTransito} />
                <StatCard title="Envíos Entregados" value={stats.entregados} />
            </div>
            <div className="bg-white p-6 rounded-xl shadow-md">
                <h3 className="text-lg font-semibold mb-4">Envíos por Estado</h3>
                <div className="space-y-2">
                    {Object.entries(stats.statusCounts).map(([status, count]) => (
                        <div key={status}>
                            <div className="flex justify-between mb-1"><span className="text-sm font-medium">{status}</span><span className="text-sm font-medium">{count}</span></div>
                            <div className="w-full bg-gray-200 rounded-full h-2.5"><div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${(count / stats.totalCargas) * 100}%` }}></div></div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- Clientes Module ---
const ClientesModule = ({ clientes, onAddClient, onDeleteClient, clientError, setClientError, newClientName, setNewClientName, newClientEmail, setNewClientEmail }) => (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
            <div className="bg-white p-6 rounded-xl shadow-md"><h2 className="text-xl font-semibold mb-4">Agregar Nuevo Cliente</h2><form onSubmit={onAddClient} className="space-y-4"><div><label className="block text-sm font-medium text-gray-700">Nombre</label><input type="text" value={newClientName} onChange={e => setNewClientName(e.target.value)} className="mt-1 block w-full input-style" /></div><div><label className="block text-sm font-medium text-gray-700">Email</label><input type="email" value={newClientEmail} onChange={e => setNewClientEmail(e.target.value)} className="mt-1 block w-full input-style" /></div>{clientError && <p className="text-red-500 text-sm">{clientError}</p>}<button type="submit" className="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Guardar Cliente</button></form></div>
        </div>
        <div>
            <div className="bg-white p-6 rounded-xl shadow-md"><h2 className="text-xl font-semibold mb-4">Clientes Guardados</h2><div className="space-y-3 max-h-96 overflow-y-auto">{clientes.length > 0 ? clientes.map(c => (<div key={c.id} className="p-3 border rounded-lg flex justify-between items-center"><div><p className="font-semibold">{c.nombre}</p><p className="text-sm text-gray-500">{c.email}</p></div><button onClick={() => onDeleteClient(c.id, 'cliente')} className="p-2 rounded-full hover:bg-red-100"><TrashIcon className="h-5 w-5 text-red-500"/></button></div>)) : <p className="text-gray-500">No hay clientes guardados.</p>}</div></div>
        </div>
    </div>
);

// --- Reportes View ---
const ReportesView = ({ cargas }) => {
    const totals = useMemo(() => {
        const totalVentas = cargas.reduce((sum, c) => sum + (c.precioVenta || 0), 0);
        const totalCostos = cargas.reduce((sum, c) => sum + (c.costoEnvio || 0), 0);
        return { totalVentas, totalCostos, totalGanancia: totalVentas - totalCostos };
    }, [cargas]);

    const handleExportExcel = () => {
        if (typeof XLSX === 'undefined') {
            alert('La librería de exportación no está lista, por favor intente de nuevo en un momento.');
            return;
        }

        const dataToExport = [
            ["Cliente", "Referencia", "Destino", "Estado", "Costo", "Venta", "Ganancia"]
        ];

        cargas.forEach(c => {
            const ganancia = (c.precioVenta || 0) - (c.costoEnvio || 0);
            dataToExport.push([
                c.cliente, c.referenciaEnvio || 'N/A', c.destino, c.estatus,
                (c.costoEnvio || 0), (c.precioVenta || 0), ganancia
            ]);
        });

        dataToExport.push([
            "", "", "", "Totales",
            totals.totalCostos, totals.totalVentas, totals.totalGanancia
        ]);

        const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);

        // Set column widths
        worksheet['!cols'] = [
            { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 15 },
            { wch: 12 }, { wch: 12 }, { wch: 12 }
        ];

        // Apply number formatting
        cargas.forEach((c, index) => {
            const rowIndex = index + 2; // 1-based index, plus header
            worksheet[`E${rowIndex}`].z = '"$"#,##0.00';
            worksheet[`F${rowIndex}`].z = '"$"#,##0.00';
            worksheet[`G${rowIndex}`].z = '"$"#,##0.00';
        });
        const totalRowIndex = cargas.length + 2;
        worksheet[`E${totalRowIndex}`].z = '"$"#,##0.00';
        worksheet[`F${totalRowIndex}`].z = '"$"#,##0.00';
        worksheet[`G${totalRowIndex}`].z = '"$"#,##0.00';
        
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Reporte de Envíos");
        XLSX.writeFile(workbook, "Reporte_De_Envios.xlsx");
    };

    return (
        <div className="bg-white p-6 rounded-xl shadow-md">
            <div className="flex justify-between items-center mb-4 no-print-in-report">
                <h2 className="text-xl font-semibold">Reporte General de Envíos</h2>
                <div className="flex gap-2">
                    <button onClick={() => window.print()} className="btn-primary bg-gray-600 hover:bg-gray-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Imprimir</button>
                    <button onClick={handleExportExcel} className="btn-primary bg-green-600 hover:bg-green-700 flex items-center"><ExcelIcon/>Exportar a Excel</button>
                </div>
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50"><tr>
                        <th className="th-style">Cliente</th><th className="th-style">Referencia</th><th className="th-style">Destino</th><th className="th-style">Estado</th>
                        <th className="th-style text-right">Costo</th><th className="th-style text-right">Venta</th><th className="th-style text-right">Ganancia</th>
                    </tr></thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {cargas.map(c => {
                            const ganancia = (c.precioVenta || 0) - (c.costoEnvio || 0);
                            return (<tr key={c.id}>
                                <td className="td-style">{c.cliente}</td><td className="td-style">{c.referenciaEnvio || 'N/A'}</td><td className="td-style">{c.destino}</td><td className="td-style">{c.estatus}</td>
                                <td className="td-style text-right">${(c.costoEnvio || 0).toFixed(2)}</td><td className="td-style text-right">${(c.precioVenta || 0).toFixed(2)}</td>
                                <td className={`td-style text-right font-semibold ${ganancia >= 0 ? 'text-green-600' : 'text-red-600'}`}>${ganancia.toFixed(2)}</td>
                            </tr>);
                        })}
                    </tbody>
                    <tfoot className="bg-gray-50"><tr>
                        <td colSpan="4" className="td-style font-bold text-right">Totales</td>
                        <td className="td-style font-bold text-right">${totals.totalCostos.toFixed(2)}</td>
                        <td className="td-style font-bold text-right">${totals.totalVentas.toFixed(2)}</td>
                        <td className={`td-style font-bold text-right ${totals.totalGanancia >= 0 ? 'text-green-600' : 'text-red-600'}`}>${totals.totalGanancia.toFixed(2)}</td>
                    </tr></tfoot>
                </table>
            </div>
            <style>{`
                .th-style { padding: 12px 16px; text-align: left; font-size: 0.875rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; }
                .td-style { padding: 12px 16px; font-size: 0.875rem; color: #4B5563; white-space: nowrap; }
            `}</style>
        </div>
    );
};

// --- Edit Modal Component ---
function EditCargaModal({ carga, onClose, onSave }) {
    const [formData, setFormData] = useState(carga);
    const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.id]: e.target.value }));
    const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full"><div className="flex justify-between items-center mb-4 border-b pb-2"><h2 className="text-xl font-semibold">Editar Carga</h2><button onClick={onClose}><CloseIcon/></button></div><form onSubmit={handleSubmit} className="space-y-4 max-h-[70vh] overflow-y-auto pr-2"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium">Cliente</label><input id="cliente" value={formData.cliente} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Email</label><input id="email" value={formData.email} onChange={handleChange} type="email" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Costo Envío</label><input id="costoEnvio" value={formData.costoEnvio} onChange={handleChange} type="number" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Precio Venta</label><input id="precioVenta" value={formData.precioVenta} onChange={handleChange} type="number" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Nº Cotización</label><input id="cotizacion" value={formData.cotizacion} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Nº Referencia</label><input id="referenciaEnvio" value={formData.referenciaEnvio} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div className="md:col-span-2"><label className="block text-sm font-medium">Origen</label><input id="origen" value={formData.origen} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div className="md:col-span-2"><label className="block text-sm font-medium">Destino</label><input id="destino" value={formData.destino} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Piezas</label><input id="piezas" value={formData.piezas} onChange={handleChange} type="number" className="mt-1 block w-full input-style"/></div><div><label className="block text-sm font-medium">Peso</label><input id="peso" value={formData.peso} onChange={handleChange} type="text" className="mt-1 block w-full input-style"/></div><div className="md:col-span-2"><label className="block text-sm font-medium">Entrega Estimada</label><input id="entregaEstimada" value={formData.entregaEstimada} onChange={handleChange} type="date" className="mt-1 block w-full input-style"/></div></div><div className="flex justify-end gap-3 pt-4"><button type="button" onClick={onClose} className="py-2 px-4 rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300">Cancelar</button><button type="submit" className="py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Guardar Cambios</button></div></form></div></div>
    );
}

// --- Delete Confirmation Modal ---
function DeleteConfirmModal({ itemType, onCancel, onConfirm }) {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center"><h3 className="text-lg font-semibold text-gray-900 mb-2">¿Estás seguro?</h3><p className="text-sm text-gray-600 mb-4">Estás a punto de eliminar este {itemType === 'carga' ? 'envío' : 'cliente'}. Esta acción no se puede deshacer.</p><div className="flex justify-center gap-3"><button onClick={onCancel} className="py-2 px-4 rounded-md text-sm font-medium bg-gray-200 hover:bg-gray-300">Cancelar</button><button onClick={onConfirm} className="py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Sí, eliminar</button></div></div></div>
    );
}
